set -e

SUBVOL=@arch
iwctl

timedatectl set-ntp true

mount /dev/sdb2 -o subvolid=5 /mnt
btrfs subvolume create /mnt/$SUBVOL
umount /mnt

mount /dev/sdb2 -o  rw,noatime,compress=zstd:3,ssd,space_cache=v2,commit=120,subvol=/$SUBVOL /mnt
mkdir -p /mnt/{boot,home,var/tmp,opt,tmp,var/log,var/cache}
mount /dev/sdb1 /mnt/boot

mount /dev/sdb2 -o rw,noatime,ssd,space_cache=v2,compress=zstd:3,commit=120,subvol=/@var_cache /var/cache

sed -i /etc/pacman.conf 's/#ParallelDownloads = 5/ParallelDownloads = 25'

pacstrap /mnt base base-devel 

cp chroot /mnt/

umount /var/cache

arch-chroot /mnt