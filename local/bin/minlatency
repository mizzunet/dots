#!/bin/bash
#Script to find out which server has lesser latency

listurl="https://raw.githubusercontent.com/tillcash/libredirect/master/src/instances/data.json"
file="/tmp/ping"
instances="$@"
attempts=2
# Download list
if ! $(test -f data.json); then
    curl -O "$listurl"
fi

for instance in $instances
do
    echo "+++++++++++++"
    echo $instance
    echo "+++++++++++++"
    echo "" > $file
    servers=$(jq .$instance.normal[] data.json | sed 's/https:\/\///g' | sed 's/"//g')

    for server in $servers
    do
        avg=$(ping -c $attempts $server 2> /dev/null | tail -1 | cut -d" " -f 4 | cut -d"/" -f2)
        if [ "$avg" = "" ]; then continue; else echo "$avg"ms https://$server >> $file; fi
    done
done

sort -n /tmp/ping
